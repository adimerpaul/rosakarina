import{_ as L,O as m,P as h,Q as s,T as o,R as t,aI as p,$ as v,V as u,U as i,aH as b,aG as C,S as f,J as k,X as x,Y as I,Z as E,W as T,bg as M,aJ as q,as as y}from"./index.9f2eac73.js";import{a as _,b as c}from"./QMenu.cbbaa7cc.js";import{Q as V}from"./QItemLabel.c144b24c.js";import{Q as N}from"./QSelect.3cf77a16.js";import{Q as Y}from"./QBtnDropdown.678ea995.js";import{Q as G}from"./QChip.cf37feb1.js";import{Q as A}from"./QMarkupTable.42805338.js";import{Q as S}from"./QSpace.ead4ebd1.js";import{Q as U}from"./QPage.1f66a738.js";import{C as F}from"./ClosePopup.56ef0817.js";import{h as Q}from"./moment.40bc58bf.js";import{I as B}from"./Imprimir.87d37dc2.js";import{E as z}from"./Excel.a5e16faf.js";import"./format.2cae61da.js";import"./QBtnGroup.be6e8c1d.js";import"./_commonjsHelpers.a26ce4be.js";const P={name:"Ventas",data(){return{ventas:[],venta:{},fechaInicio:Q().format("YYYY-MM-DD"),fechaFin:Q().format("YYYY-MM-DD"),loading:!1,users:[],user:"",devDialog:!1,gastoDialog:!1,gastoLoading:!1,gastoForm:{fecha:Q().format("YYYY-MM-DD"),concepto:"",monto:null,tipo_pago:"Efectivo"}}},mounted(){this.ventasGet(),this.usersGet()},methods:{openGastoDialog(){this.gastoForm={fecha:Q().format("YYYY-MM-DD"),concepto:"",monto:null,tipo_pago:"Efectivo"},this.gastoDialog=!0},guardarGasto(){const n=String(this.gastoForm.concepto||"").trim(),e=Number(this.gastoForm.monto);if(!n){this.$q.notify({type:"warning",message:"Ingrese el concepto del gasto"});return}if(isNaN(e)||e<=0){this.$q.notify({type:"warning",message:"Ingrese un monto v\xE1lido"});return}this.gastoLoading=!0,this.$axios.post("ventasGasto",{fecha:this.gastoForm.fecha,concepto:n,monto:e,tipo_pago:this.gastoForm.tipo_pago}).then(()=>{this.$alert.success("Gasto registrado"),this.gastoDialog=!1,this.ventasGet()}).catch(r=>{var g,a;this.$alert.error(((a=(g=r==null?void 0:r.response)==null?void 0:g.data)==null?void 0:a.message)||"Error al registrar gasto")}).finally(()=>{this.gastoLoading=!1})},devolverProducto(n,e,r){this.$q.dialog({title:"Devolver producto",message:`Ingrese la cantidad a devolver (vendido: ${r}):`,prompt:{model:r,type:"number",isValid:g=>{const a=Number(g);return!isNaN(a)&&a>0&&a<=r},label:"Cantidad a devolver",hint:`Debe ser un n\xFAmero entre 1 y ${r}`,mask:"##########"},cancel:!0,persistent:!0}).onOk(g=>{const a=Number(g);if(isNaN(a)||a<=0||a>r){this.$alert.error("Cantidad inv\xE1lida");return}this.$axios.post("ventasDevolverProducto",{venta_id:n,venta_detalle_id:e,cantidad:a}).then(()=>{this.$alert.success("Producto devuelto correctamente"),this.devDialog=!1,this.ventasGet()}).catch(d=>{this.$alert.error(d.response.data.message)})})},openDevolver(n){this.venta=n,this.devDialog=!0},exportExcel(){const n=(this.ventas||[]).filter(r=>String(r.estado).toLowerCase()==="activo");if(n.length===0){this.$q.notify({type:"warning",message:"No hay ventas ACTIVAS para exportar"});return}const e=[{columns:[{label:"ID",value:"id"},{label:"Fecha",value:"fecha"},{label:"Cliente",value:"nombre"},{label:"Usuario",value:"user.name"},{label:"Estado",value:"estado"},{label:"Total",value:"total"},{label:"Tipo comprobante",value:"tipo_comprobante"},{label:"Detalle",value:"detailsText"}],content:n}];z.export(e,"Ventas_Activas")},usersGet(){this.$axios.get("users").then(n=>{this.users=n.data}).catch(n=>{this.$alert.error(n.response.data.message)})},imprimir(n){B.reciboVentaSimple(n)},tipoVentasChange(n){this.$axios.put(`tipoVentasChange/${n}`).then(()=>{this.$alert.success("Tipo de venta cambiado"),this.ventasGet()}).catch(e=>{this.$alert.error(e.response.data.message)})},anular(n){this.$alert.dialog("\xBFEst\xE1 seguro de anular?").onOk(()=>{this.$axios.put(`ventasAnular/${n}`).then(()=>{this.$alert.success("Anulado"),this.ventasGet()}).catch(e=>{this.$alert.error(e.response.data.message)})})},ventasGet(){this.loading=!0,this.$axios.get("ventas",{params:{fechaInicio:this.fechaInicio,fechaFin:this.fechaFin,user:this.user}}).then(n=>{this.ventas=n.data}).catch(n=>{this.$alert.error(n.response.data.message)}).finally(()=>{this.loading=!1})}},computed:{totalGastos(){return this.ventas.reduce((n,e)=>String(e.tipo_comprobante||"").toLowerCase()==="gastos"&&e.estado==="Activo"?n+parseFloat(e.total||0):n,0)},totalVentas(){return this.ventas.reduce((n,e)=>String(e.tipo_comprobante||"").toLowerCase()!=="gastos"&&e.estado==="Activo"?n+parseFloat(e.total||0):n,0)},usersTodos(){return[{label:"Todos",value:""},...this.users.map(n=>({label:n.name,value:n.id}))]},totalInternos(){return this.ventas.reduce((n,e)=>String(e.tipo_comprobante||"").toLowerCase()!=="gastos"&&e.tipo_venta==="Internado"&&e.estado==="Activo"?n+parseFloat(e.total||0):n,0)},totalExternos(){return this.ventas.reduce((n,e)=>String(e.tipo_comprobante||"").toLowerCase()!=="gastos"&&e.tipo_venta==="Externo"&&e.estado==="Activo"?n+parseFloat(e.total||0):n,0)}}},O={class:"row"},R={class:"col-12 col-md-4 q-pa-xs"},H={class:"col-12 col-md-4 q-pa-xs"},j={class:"col-12 col-md-4 q-pa-xs"},J={class:"col-12"},W={class:"row q-col-gutter-sm items-center q-pa-sm"},X={class:"col-12 col-md-2"},Z={class:"col-12 col-md-2"},K={class:"col-12 col-md-2"},$={class:"col-12 col-md-1"},ee={class:"col-12 col-md-1 text-right"},te={class:"col-12 col-md-2 text-right"},oe={class:"row justify-end q-gutter-sm"},le={class:"col-12 col-md-2 text-right"},se={class:"text-bold"},ae={key:0,class:"text-negative"},ne={key:1},ie=["innerHTML"],re={class:"text-center"},de={style:{"max-width":"360px",overflow:"hidden","text-overflow":"ellipsis"}},ue={class:"text-center"},ce={class:"text-center"},me={class:"text-center"};function pe(n,e,r,g,a,d){return m(),h(U,{class:"q-pa-xs"},{default:s(()=>[o("div",O,[o("div",R,[t(b,{flat:"",bordered:""},{default:s(()=>[t(p,{class:"q-pa-none"},{default:s(()=>[t(_,{class:"bg-indigo"},{default:s(()=>[t(c,{avatar:""},{default:s(()=>[t(v,{name:"monetization_on",size:"50px",color:"white"})]),_:1}),t(c,null,{default:s(()=>[t(V,{caption:"",class:"text-white"},{default:s(()=>e[13]||(e[13]=[u("Ventas Ganancia")])),_:1}),t(V,{class:"text-white text-h4"},{default:s(()=>[u(i(d.totalVentas-d.totalGastos)+" Bs",1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),o("div",H,[t(b,{flat:"",bordered:""},{default:s(()=>[t(p,{class:"q-pa-none"},{default:s(()=>[t(_,{class:"bg-green"},{default:s(()=>[t(c,{avatar:""},{default:s(()=>[t(v,{name:"monetization_on",size:"50px",color:"white"})]),_:1}),t(c,null,{default:s(()=>[t(V,{caption:"",class:"text-white"},{default:s(()=>e[14]||(e[14]=[u("Ventas")])),_:1}),t(V,{class:"text-white text-h4"},{default:s(()=>[u(i(d.totalVentas)+" Bs",1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),o("div",j,[t(b,{flat:"",bordered:""},{default:s(()=>[t(p,{class:"q-pa-none"},{default:s(()=>[t(_,{class:"bg-red"},{default:s(()=>[t(c,{avatar:""},{default:s(()=>[t(v,{name:"monetization_on",size:"50px",color:"white"})]),_:1}),t(c,null,{default:s(()=>[t(V,{caption:"",class:"text-white"},{default:s(()=>e[15]||(e[15]=[u("Gastos")])),_:1}),t(V,{class:"text-white text-h4"},{default:s(()=>[u(i(d.totalGastos)+" Bs",1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),o("div",J,[t(b,{flat:"",bordered:""},{default:s(()=>[t(p,{class:"q-pa-none"},{default:s(()=>[o("div",W,[o("div",X,[t(C,{modelValue:a.fechaInicio,"onUpdate:modelValue":e[0]||(e[0]=l=>a.fechaInicio=l),label:"Fecha inicio",dense:"",outlined:"",type:"date"},null,8,["modelValue"])]),o("div",Z,[t(C,{modelValue:a.fechaFin,"onUpdate:modelValue":e[1]||(e[1]=l=>a.fechaFin=l),label:"Fecha fin",dense:"",outlined:"",type:"date"},null,8,["modelValue"])]),o("div",K,[t(N,{modelValue:a.user,"onUpdate:modelValue":e[2]||(e[2]=l=>a.user=l),options:d.usersTodos,label:"Usuario",dense:"",outlined:"","emit-value":"","map-options":""},null,8,["modelValue","options"])]),o("div",$,[t(f,{color:"primary",label:"Buscar","no-caps":"",icon:"search",loading:a.loading,onClick:e[3]||(e[3]=l=>d.ventasGet()),dense:""},null,8,["loading"])]),o("div",ee,[t(Y,{color:"primary",label:"Exportar","no-caps":"",dense:""},{default:s(()=>[k((m(),h(_,{clickable:"",onClick:d.exportExcel},{default:s(()=>[t(c,{avatar:""},{default:s(()=>[t(v,{name:"file_download"})]),_:1}),t(c,null,{default:s(()=>e[16]||(e[16]=[u("Excel")])),_:1})]),_:1},8,["onClick"])),[[y],[F]])]),_:1})]),o("div",te,[o("div",oe,[t(f,{color:"positive",label:"Nueva venta","no-caps":"",dense:"",icon:"add_circle_outline",loading:a.loading,to:"/ventaNuevo"},null,8,["loading"])])]),o("div",le,[t(f,{color:"negative",label:"Gasto","no-caps":"",dense:"",icon:"remove_circle_outline",onClick:d.openGastoDialog},null,8,["onClick"])])])]),_:1})]),_:1})])]),t(A,{dense:"","wrap-cells":""},{default:s(()=>[e[22]||(e[22]=o("thead",null,[o("tr",{class:"bg-primary text-white"},[o("th",null,"Acciones"),o("th",null,"ID"),o("th",null,"Fecha"),o("th",null,"Cliente / Concepto"),o("th",null,"Usuario"),o("th",null,"Estado"),o("th",null,"Total"),o("th",null,"Productos"),o("th",null,"Detalles"),o("th",null,"Tipo")])],-1)),o("tbody",null,[a.ventas.length!==0?(m(!0),x(E,{key:0},I(a.ventas,l=>{var D;return m(),x("tr",{key:l.id},[o("td",null,[t(Y,{color:"primary",label:"Opciones","no-caps":"",dense:"",size:"10px"},{default:s(()=>[k((m(),h(_,{clickable:"",onClick:w=>d.imprimir(l)},{default:s(()=>[t(c,{avatar:""},{default:s(()=>[t(v,{name:"print"})]),_:1}),t(c,null,{default:s(()=>e[17]||(e[17]=[u("Imprimir")])),_:1})]),_:2},1032,["onClick"])),[[y],[F]]),k((m(),h(_,{clickable:"",onClick:w=>d.anular(l.id)},{default:s(()=>[t(c,{avatar:""},{default:s(()=>[t(v,{name:"delete"})]),_:1}),t(c,null,{default:s(()=>e[18]||(e[18]=[u("Anular")])),_:1})]),_:2},1032,["onClick"])),[[y],[F]]),l.estado==="Activo"&&l.tipo_comprobante!=="Gastos"?k((m(),h(_,{key:0,clickable:"",onClick:w=>d.openDevolver(l)},{default:s(()=>[t(c,{avatar:""},{default:s(()=>[t(v,{name:"undo"})]),_:1}),t(c,null,{default:s(()=>e[19]||(e[19]=[u("Devolver productos")])),_:1})]),_:2},1032,["onClick"])),[[y],[F]]):T("",!0)]),_:2},1024)]),o("td",null,i(l.id),1),o("td",null,i(l.fecha)+" "+i(l.hora),1),o("td",null,i(l.tipo_comprobante==="Gastos"?l.nombre||"Gasto":l.nombre||"SN"),1),o("td",null,i(((D=l.user)==null?void 0:D.name)||"\u2014"),1),o("td",null,[t(G,{color:l.estado==="Activo"?"positive":"negative",class:"text-white",dense:""},{default:s(()=>[u(i(l.estado),1)]),_:2},1032,["color"])]),o("td",se,[l.tipo_comprobante==="Gastos"?(m(),x("span",ae," - "+i(l.total),1)):(m(),x("span",ne,i(l.total),1)),t(G,{size:"10px",color:l.tipo_pago==="Efectivo"?"green":"blue",class:"text-white",dense:""},{default:s(()=>[u(i((l.tipo_pago||"E").charAt(0)),1)]),_:2},1032,["color"])]),o("td",null,[o("div",{style:{"max-width":"200px","line-height":"1.2","white-space":"normal",overflow:"hidden","text-overflow":"ellipsis"},innerHTML:l.detailsText||"\u2014"},null,8,ie)]),o("td",null,i(l.detalles||"\u2014"),1),o("td",null,[l.tipo_comprobante==="Gastos"?(m(),h(G,{key:0,color:"negative",class:"text-white",dense:""},{default:s(()=>e[20]||(e[20]=[u(" Gasto ")])),_:1})):(m(),h(G,{key:1,color:"teal",class:"text-white",dense:""},{default:s(()=>e[21]||(e[21]=[u(" Venta ")])),_:1}))])])}),128)):T("",!0)])]),_:1}),t(q,{modelValue:a.gastoDialog,"onUpdate:modelValue":e[10]||(e[10]=l=>a.gastoDialog=l),persistent:""},{default:s(()=>[t(b,{style:{width:"520px","max-width":"95vw"}},{default:s(()=>[t(p,{class:"row items-center q-pb-none"},{default:s(()=>[e[23]||(e[23]=o("div",{class:"text-h6"},"Registrar gasto",-1)),t(S),t(f,{flat:"",round:"",dense:"",icon:"close",onClick:e[4]||(e[4]=l=>a.gastoDialog=!1)})]),_:1}),t(p,{class:"q-gutter-sm"},{default:s(()=>[t(C,{modelValue:a.gastoForm.fecha,"onUpdate:modelValue":e[5]||(e[5]=l=>a.gastoForm.fecha=l),type:"date",dense:"",outlined:"",label:"Fecha"},null,8,["modelValue"]),t(C,{modelValue:a.gastoForm.concepto,"onUpdate:modelValue":e[6]||(e[6]=l=>a.gastoForm.concepto=l),dense:"",outlined:"",label:"Concepto / Descripci\xF3n"},null,8,["modelValue"]),t(C,{modelValue:a.gastoForm.monto,"onUpdate:modelValue":e[7]||(e[7]=l=>a.gastoForm.monto=l),modelModifiers:{number:!0},type:"number",min:"0",step:"0.01",dense:"",outlined:"",label:"Monto (Bs.)"},null,8,["modelValue"]),t(N,{modelValue:a.gastoForm.tipo_pago,"onUpdate:modelValue":e[8]||(e[8]=l=>a.gastoForm.tipo_pago=l),options:["Efectivo","QR","Tarjeta","Transferencia"],dense:"",outlined:"",label:"Tipo pago"},null,8,["modelValue"])]),_:1}),t(M,{align:"right"},{default:s(()=>[t(f,{flat:"",label:"Cancelar","no-caps":"",onClick:e[9]||(e[9]=l=>a.gastoDialog=!1)}),t(f,{color:"negative",label:"Guardar gasto","no-caps":"",loading:a.gastoLoading,onClick:d.guardarGasto},null,8,["loading","onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(q,{modelValue:a.devDialog,"onUpdate:modelValue":e[12]||(e[12]=l=>a.devDialog=l),persistent:""},{default:s(()=>[t(b,{style:{"max-width":"860px",width:"95vw"}},{default:s(()=>[t(p,{class:"row items-center q-pb-none"},{default:s(()=>[e[24]||(e[24]=o("div",{class:"text-h6"},"Devolver productos",-1)),t(S),t(f,{flat:"",round:"",dense:"",icon:"close",onClick:e[11]||(e[11]=l=>a.devDialog=!1)})]),_:1}),t(p,null,{default:s(()=>[t(A,{dense:"","wrap-cells":"",flat:"",bordered:""},{default:s(()=>[e[25]||(e[25]=o("thead",null,[o("tr",null,[o("th",null,"#"),o("th",null,"Producto"),o("th",null,"Lote"),o("th",null,"Vencimiento"),o("th",{style:{width:"100px"}},"Vendido"),o("th",{style:{width:"140px"}},"Devolver")])],-1)),o("tbody",null,[(m(!0),x(E,null,I(a.venta.venta_detalles,(l,D)=>{var w;return m(),x("tr",{key:l.id},[o("td",re,i(D+1),1),o("td",de,i(l.nombre||((w=l.producto)==null?void 0:w.nombre)||"\u2014"),1),o("td",ue,i(l.lote||"\u2014"),1),o("td",ce,i(l.fecha_vencimiento||"\u2014"),1),o("td",me,i(l.cantidad),1),o("td",null,[t(f,{size:"sm",color:"negative",label:"Devolver","no-caps":"",onClick:fe=>d.devolverProducto(a.venta.id,l.id,l.cantidad),icon:"undo"},null,8,["onClick"])])])}),128))])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),e[26]||(e[26]=o("div",{id:"myElement",class:"hidden"},null,-1))]),_:1})}var Ee=L(P,[["render",pe]]);export{Ee as default};
