import{_ as q,O as m,P as _,Q as l,T as o,R as t,aI as b,$ as p,V as u,U as i,aH as D,aG as V,S as g,J as k,X as x,Y as E,Z as I,W as N,bg as M,aJ as T,as as y}from"./index.07a95aa4.js";import{a as f,b as c}from"./QMenu.94acaf5c.js";import{Q as h}from"./QItemLabel.0f42b482.js";import{Q as A}from"./QSelect.d70b65ff.js";import{Q as S}from"./QBtnDropdown.522e935a.js";import{Q as F}from"./QChip.33b7d629.js";import{Q as Y}from"./QMarkupTable.eda05d2d.js";import{Q as L}from"./QSpace.4fc8d707.js";import{Q as U}from"./QPage.612be5e6.js";import{C as G}from"./ClosePopup.73a0ce7b.js";import{h as Q}from"./moment.40bc58bf.js";import{I as B}from"./Imprimir.a89efa67.js";import{E as z}from"./Excel.a5e16faf.js";import"./format.2cae61da.js";import"./QBtnGroup.91ee93c7.js";import"./_commonjsHelpers.a26ce4be.js";const P={name:"Ventas",data(){return{ventas:[],venta:{},fechaInicio:Q().format("YYYY-MM-DD"),fechaFin:Q().format("YYYY-MM-DD"),loading:!1,users:[],user:"",devDialog:!1,gastoDialog:!1,gastoLoading:!1,gastoForm:{fecha:Q().format("YYYY-MM-DD"),concepto:"",monto:null,tipo_pago:"Efectivo"}}},mounted(){this.ventasGet(),this.usersGet()},methods:{openGastoDialog(){this.gastoForm={fecha:Q().format("YYYY-MM-DD"),concepto:"",monto:null,tipo_pago:"Efectivo"},this.gastoDialog=!0},guardarGasto(){const a=String(this.gastoForm.concepto||"").trim(),e=Number(this.gastoForm.monto);if(!a){this.$q.notify({type:"warning",message:"Ingrese el concepto del gasto"});return}if(isNaN(e)||e<=0){this.$q.notify({type:"warning",message:"Ingrese un monto v\xE1lido"});return}this.gastoLoading=!0,this.$axios.post("ventasGasto",{fecha:this.gastoForm.fecha,concepto:a,monto:e,tipo_pago:this.gastoForm.tipo_pago}).then(()=>{this.$alert.success("Gasto registrado"),this.gastoDialog=!1,this.ventasGet()}).catch(r=>{var v,n;this.$alert.error(((n=(v=r==null?void 0:r.response)==null?void 0:v.data)==null?void 0:n.message)||"Error al registrar gasto")}).finally(()=>{this.gastoLoading=!1})},devolverProducto(a,e,r){this.$q.dialog({title:"Devolver producto",message:`Ingrese la cantidad a devolver (vendido: ${r}):`,prompt:{model:r,type:"number",isValid:v=>{const n=Number(v);return!isNaN(n)&&n>0&&n<=r},label:"Cantidad a devolver",hint:`Debe ser un n\xFAmero entre 1 y ${r}`,mask:"##########"},cancel:!0,persistent:!0}).onOk(v=>{const n=Number(v);if(isNaN(n)||n<=0||n>r){this.$alert.error("Cantidad inv\xE1lida");return}this.$axios.post("ventasDevolverProducto",{venta_id:a,venta_detalle_id:e,cantidad:n}).then(()=>{this.$alert.success("Producto devuelto correctamente"),this.devDialog=!1,this.ventasGet()}).catch(d=>{this.$alert.error(d.response.data.message)})})},openDevolver(a){this.venta=a,this.devDialog=!0},exportExcel(){const a=(this.ventas||[]).filter(r=>String(r.estado).toLowerCase()==="activo");if(a.length===0){this.$q.notify({type:"warning",message:"No hay ventas ACTIVAS para exportar"});return}const e=[{columns:[{label:"ID",value:"id"},{label:"Fecha",value:"fecha"},{label:"Cliente",value:"nombre"},{label:"Usuario",value:"user.name"},{label:"Estado",value:"estado"},{label:"Total",value:"total"},{label:"Tipo comprobante",value:"tipo_comprobante"},{label:"Detalle",value:"detailsText"}],content:a}];z.export(e,"Ventas_Activas")},usersGet(){this.$axios.get("users").then(a=>{this.users=a.data}).catch(a=>{this.$alert.error(a.response.data.message)})},imprimir(a){B.reciboVentaSimple(a)},tipoVentasChange(a){this.$axios.put(`tipoVentasChange/${a}`).then(()=>{this.$alert.success("Tipo de venta cambiado"),this.ventasGet()}).catch(e=>{this.$alert.error(e.response.data.message)})},anular(a){this.$alert.dialog("\xBFEst\xE1 seguro de anular?").onOk(()=>{this.$axios.put(`ventasAnular/${a}`).then(()=>{this.$alert.success("Anulado"),this.ventasGet()}).catch(e=>{this.$alert.error(e.response.data.message)})})},ventasGet(){this.loading=!0,this.$axios.get("ventas",{params:{fechaInicio:this.fechaInicio,fechaFin:this.fechaFin,user:this.user}}).then(a=>{this.ventas=a.data}).catch(a=>{this.$alert.error(a.response.data.message)}).finally(()=>{this.loading=!1})}},computed:{totalQR(){return this.ventas.reduce((a,e)=>String(e.tipo_comprobante||"").toLowerCase()!=="gastos"&&e.tipo_pago==="QR"&&e.estado==="Activo"?a+parseFloat(e.total||0):a,0)},totalEfectivo(){return this.ventas.reduce((a,e)=>String(e.tipo_comprobante||"").toLowerCase()!=="gastos"&&e.tipo_pago==="Efectivo"&&e.estado==="Activo"?a+parseFloat(e.total||0):a,0)},totalGastos(){return this.ventas.reduce((a,e)=>String(e.tipo_comprobante||"").toLowerCase()==="gastos"&&e.estado==="Activo"?a+parseFloat(e.total||0):a,0)},totalVentas(){return this.ventas.reduce((a,e)=>String(e.tipo_comprobante||"").toLowerCase()!=="gastos"&&e.estado==="Activo"?a+parseFloat(e.total||0):a,0)},usersTodos(){return[{label:"Todos",value:""},...this.users.map(a=>({label:a.name,value:a.id}))]},totalInternos(){return this.ventas.reduce((a,e)=>String(e.tipo_comprobante||"").toLowerCase()!=="gastos"&&e.tipo_venta==="Internado"&&e.estado==="Activo"?a+parseFloat(e.total||0):a,0)},totalExternos(){return this.ventas.reduce((a,e)=>String(e.tipo_comprobante||"").toLowerCase()!=="gastos"&&e.tipo_venta==="Externo"&&e.estado==="Activo"?a+parseFloat(e.total||0):a,0)}}},R={class:"row"},O={class:"col-12"},H={class:"row q-col-gutter-sm items-center q-pa-sm"},j={class:"col-12 col-md-3"},J={class:"col-12 col-md-3"},W={class:"col-12 col-md-3"},X={class:"col-12 col-md-3"},Z={class:"col-12"},K={class:"row q-col-gutter-sm items-center q-pa-sm"},$={class:"col-12 col-md-2"},ee={class:"col-12 col-md-2"},te={class:"col-12 col-md-2"},oe={class:"col-12 col-md-1"},se={class:"col-12 col-md-1 text-right"},le={class:"col-12 col-md-2 text-right"},ae={class:"row justify-end q-gutter-sm"},ne={class:"col-12 col-md-2 text-right"},ie={class:"text-bold"},re={key:0,class:"text-negative"},de={key:1},ue=["innerHTML"],ce={class:"text-center"},me={style:{"max-width":"360px",overflow:"hidden","text-overflow":"ellipsis"}},pe={class:"text-center"},ge={class:"text-center"},fe={class:"text-center"};function he(a,e,r,v,n,d){return m(),_(U,{class:"q-pa-xs"},{default:l(()=>[o("div",R,[o("div",O,[t(D,{flat:"",bordered:""},{default:l(()=>[t(b,{class:"q-pa-none"},{default:l(()=>[o("div",H,[o("div",j,[t(f,{class:"bg-green"},{default:l(()=>[t(c,{avatar:""},{default:l(()=>[t(p,{name:"monetization_on",size:"40px",color:"white"})]),_:1}),t(c,null,{default:l(()=>[t(h,{caption:"",class:"text-white"},{default:l(()=>e[13]||(e[13]=[u(" Ventas Efectivo ")])),_:1}),t(h,{class:"text-white text-h5"},{default:l(()=>[u(i(d.totalEfectivo)+" Bs ",1)]),_:1})]),_:1})]),_:1})]),o("div",J,[t(f,{class:"bg-orange"},{default:l(()=>[t(c,{avatar:""},{default:l(()=>[t(p,{name:"monetization_on",size:"40px",color:"white"})]),_:1}),t(c,null,{default:l(()=>[t(h,{caption:"",class:"text-white"},{default:l(()=>e[14]||(e[14]=[u(" Ventas QR ")])),_:1}),t(h,{class:"text-white text-h5"},{default:l(()=>[u(i(d.totalQR)+" Bs ",1)]),_:1})]),_:1})]),_:1})]),o("div",W,[t(f,{class:"bg-red"},{default:l(()=>[t(c,{avatar:""},{default:l(()=>[t(p,{name:"monetization_on",size:"40px",color:"white"})]),_:1}),t(c,null,{default:l(()=>[t(h,{caption:"",class:"text-white"},{default:l(()=>e[15]||(e[15]=[u(" Gastos ")])),_:1}),t(h,{class:"text-white text-h5"},{default:l(()=>[u(i(d.totalGastos)+" Bs ",1)]),_:1})]),_:1})]),_:1})]),o("div",X,[t(f,{class:"bg-indigo"},{default:l(()=>[t(c,{avatar:""},{default:l(()=>[t(p,{name:"monetization_on",size:"40px",color:"white"})]),_:1}),t(c,null,{default:l(()=>[t(h,{caption:"",class:"text-white"},{default:l(()=>e[16]||(e[16]=[u(" Neto ")])),_:1}),t(h,{class:"text-white text-h5"},{default:l(()=>[u(i(d.totalEfectivo+d.totalQR-d.totalGastos)+" Bs ",1)]),_:1})]),_:1})]),_:1})])])]),_:1})]),_:1})]),o("div",Z,[t(D,{flat:"",bordered:""},{default:l(()=>[t(b,{class:"q-pa-none"},{default:l(()=>[o("div",K,[o("div",$,[t(V,{modelValue:n.fechaInicio,"onUpdate:modelValue":e[0]||(e[0]=s=>n.fechaInicio=s),label:"Fecha inicio",dense:"",outlined:"",type:"date"},null,8,["modelValue"])]),o("div",ee,[t(V,{modelValue:n.fechaFin,"onUpdate:modelValue":e[1]||(e[1]=s=>n.fechaFin=s),label:"Fecha fin",dense:"",outlined:"",type:"date"},null,8,["modelValue"])]),o("div",te,[t(A,{modelValue:n.user,"onUpdate:modelValue":e[2]||(e[2]=s=>n.user=s),options:d.usersTodos,label:"Usuario",dense:"",outlined:"","emit-value":"","map-options":""},null,8,["modelValue","options"])]),o("div",oe,[t(g,{color:"primary",label:"Buscar","no-caps":"",icon:"search",loading:n.loading,onClick:e[3]||(e[3]=s=>d.ventasGet()),dense:""},null,8,["loading"])]),o("div",se,[t(S,{color:"primary",label:"Exportar","no-caps":"",dense:""},{default:l(()=>[k((m(),_(f,{clickable:"",onClick:d.exportExcel},{default:l(()=>[t(c,{avatar:""},{default:l(()=>[t(p,{name:"file_download"})]),_:1}),t(c,null,{default:l(()=>e[17]||(e[17]=[u("Excel")])),_:1})]),_:1},8,["onClick"])),[[y],[G]])]),_:1})]),o("div",le,[o("div",ae,[t(g,{color:"positive",label:"Nueva venta","no-caps":"",dense:"",icon:"add_circle_outline",loading:n.loading,to:"/ventaNuevo"},null,8,["loading"])])]),o("div",ne,[t(g,{color:"negative",label:"Gasto","no-caps":"",dense:"",icon:"remove_circle_outline",onClick:d.openGastoDialog},null,8,["onClick"])])])]),_:1})]),_:1})])]),t(Y,{dense:"","wrap-cells":""},{default:l(()=>[e[23]||(e[23]=o("thead",null,[o("tr",{class:"bg-primary text-white"},[o("th",null,"Acciones"),o("th",null,"ID"),o("th",null,"Fecha"),o("th",null,"Cliente / Concepto"),o("th",null,"Usuario"),o("th",null,"Estado"),o("th",null,"Total"),o("th",null,"Productos"),o("th",null,"Detalles"),o("th",null,"Tipo")])],-1)),o("tbody",null,[n.ventas.length!==0?(m(!0),x(I,{key:0},E(n.ventas,s=>{var C;return m(),x("tr",{key:s.id},[o("td",null,[t(S,{color:"primary",label:"Opciones","no-caps":"",dense:"",size:"10px"},{default:l(()=>[k((m(),_(f,{clickable:"",onClick:w=>d.imprimir(s)},{default:l(()=>[t(c,{avatar:""},{default:l(()=>[t(p,{name:"print"})]),_:1}),t(c,null,{default:l(()=>e[18]||(e[18]=[u("Imprimir")])),_:1})]),_:2},1032,["onClick"])),[[y],[G]]),k((m(),_(f,{clickable:"",onClick:w=>d.anular(s.id)},{default:l(()=>[t(c,{avatar:""},{default:l(()=>[t(p,{name:"delete"})]),_:1}),t(c,null,{default:l(()=>e[19]||(e[19]=[u("Anular")])),_:1})]),_:2},1032,["onClick"])),[[y],[G]]),s.estado==="Activo"&&s.tipo_comprobante!=="Gastos"?k((m(),_(f,{key:0,clickable:"",onClick:w=>d.openDevolver(s)},{default:l(()=>[t(c,{avatar:""},{default:l(()=>[t(p,{name:"undo"})]),_:1}),t(c,null,{default:l(()=>e[20]||(e[20]=[u("Devolver productos")])),_:1})]),_:2},1032,["onClick"])),[[y],[G]]):N("",!0)]),_:2},1024)]),o("td",null,i(s.id),1),o("td",null,i(s.fecha)+" "+i(s.hora),1),o("td",null,i(s.tipo_comprobante==="Gastos"?s.nombre||"Gasto":s.nombre||"SN"),1),o("td",null,i(((C=s.user)==null?void 0:C.name)||"\u2014"),1),o("td",null,[t(F,{color:s.estado==="Activo"?"positive":"negative",class:"text-white",dense:""},{default:l(()=>[u(i(s.estado),1)]),_:2},1032,["color"])]),o("td",ie,[s.tipo_comprobante==="Gastos"?(m(),x("span",re," - "+i(s.total),1)):(m(),x("span",de,i(s.total),1)),t(F,{size:"10px",color:s.tipo_pago==="Efectivo"?"green":"blue",class:"text-white",dense:""},{default:l(()=>[u(i((s.tipo_pago||"E").charAt(0)),1)]),_:2},1032,["color"])]),o("td",null,[o("div",{style:{"max-width":"200px","line-height":"1.2","white-space":"normal",overflow:"hidden","text-overflow":"ellipsis"},innerHTML:s.detailsText||"\u2014"},null,8,ue)]),o("td",null,i(s.detalles||"\u2014"),1),o("td",null,[s.tipo_comprobante==="Gastos"?(m(),_(F,{key:0,color:"negative",class:"text-white",dense:""},{default:l(()=>e[21]||(e[21]=[u(" Gasto ")])),_:1})):(m(),_(F,{key:1,color:"teal",class:"text-white",dense:""},{default:l(()=>e[22]||(e[22]=[u(" Venta ")])),_:1}))])])}),128)):N("",!0)])]),_:1}),t(T,{modelValue:n.gastoDialog,"onUpdate:modelValue":e[10]||(e[10]=s=>n.gastoDialog=s),persistent:""},{default:l(()=>[t(D,{style:{width:"520px","max-width":"95vw"}},{default:l(()=>[t(b,{class:"row items-center q-pb-none"},{default:l(()=>[e[24]||(e[24]=o("div",{class:"text-h6"},"Registrar gasto",-1)),t(L),t(g,{flat:"",round:"",dense:"",icon:"close",onClick:e[4]||(e[4]=s=>n.gastoDialog=!1)})]),_:1}),t(b,{class:"q-gutter-sm"},{default:l(()=>[t(V,{modelValue:n.gastoForm.fecha,"onUpdate:modelValue":e[5]||(e[5]=s=>n.gastoForm.fecha=s),type:"date",dense:"",outlined:"",label:"Fecha"},null,8,["modelValue"]),t(V,{modelValue:n.gastoForm.concepto,"onUpdate:modelValue":e[6]||(e[6]=s=>n.gastoForm.concepto=s),dense:"",outlined:"",label:"Concepto / Descripci\xF3n"},null,8,["modelValue"]),t(V,{modelValue:n.gastoForm.monto,"onUpdate:modelValue":e[7]||(e[7]=s=>n.gastoForm.monto=s),modelModifiers:{number:!0},type:"number",min:"0",step:"0.01",dense:"",outlined:"",label:"Monto (Bs.)"},null,8,["modelValue"]),t(A,{modelValue:n.gastoForm.tipo_pago,"onUpdate:modelValue":e[8]||(e[8]=s=>n.gastoForm.tipo_pago=s),options:["Efectivo","QR","Tarjeta","Transferencia"],dense:"",outlined:"",label:"Tipo pago"},null,8,["modelValue"])]),_:1}),t(M,{align:"right"},{default:l(()=>[t(g,{flat:"",label:"Cancelar","no-caps":"",onClick:e[9]||(e[9]=s=>n.gastoDialog=!1)}),t(g,{color:"negative",label:"Guardar gasto","no-caps":"",loading:n.gastoLoading,onClick:d.guardarGasto},null,8,["loading","onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(T,{modelValue:n.devDialog,"onUpdate:modelValue":e[12]||(e[12]=s=>n.devDialog=s),persistent:""},{default:l(()=>[t(D,{style:{"max-width":"860px",width:"95vw"}},{default:l(()=>[t(b,{class:"row items-center q-pb-none"},{default:l(()=>[e[25]||(e[25]=o("div",{class:"text-h6"},"Devolver productos",-1)),t(L),t(g,{flat:"",round:"",dense:"",icon:"close",onClick:e[11]||(e[11]=s=>n.devDialog=!1)})]),_:1}),t(b,null,{default:l(()=>[t(Y,{dense:"","wrap-cells":"",flat:"",bordered:""},{default:l(()=>[e[26]||(e[26]=o("thead",null,[o("tr",null,[o("th",null,"#"),o("th",null,"Producto"),o("th",null,"Lote"),o("th",null,"Vencimiento"),o("th",{style:{width:"100px"}},"Vendido"),o("th",{style:{width:"140px"}},"Devolver")])],-1)),o("tbody",null,[(m(!0),x(I,null,E(n.venta.venta_detalles,(s,C)=>{var w;return m(),x("tr",{key:s.id},[o("td",ce,i(C+1),1),o("td",me,i(s.nombre||((w=s.producto)==null?void 0:w.nombre)||"\u2014"),1),o("td",pe,i(s.lote||"\u2014"),1),o("td",ge,i(s.fecha_vencimiento||"\u2014"),1),o("td",fe,i(s.cantidad),1),o("td",null,[t(g,{size:"sm",color:"negative",label:"Devolver","no-caps":"",onClick:ve=>d.devolverProducto(n.venta.id,s.id,s.cantidad),icon:"undo"},null,8,["onClick"])])])}),128))])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),e[27]||(e[27]=o("div",{id:"myElement",class:"hidden"},null,-1))]),_:1})}var Ae=q(P,[["render",he]]);export{Ae as default};
