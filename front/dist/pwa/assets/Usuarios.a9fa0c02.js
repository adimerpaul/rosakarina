import{_ as F,O as u,P as p,Q as a,R as l,S as n,aG as h,$ as c,J as v,V as C,a1 as y,T as i,X as Q,Y as G,Z as q,aH as _,aI as f,U as P,W as U,aJ as x,aK as S}from"./index.f5457207.js";import{Q as b,a as d}from"./QItem.f9bf5b17.js";import{Q as k}from"./QItemLabel.ab17f4fc.js";import{Q as E}from"./QList.8288854e.js";import{Q as z}from"./QBtnDropdown.8d1780b4.js";import{Q as V,a as I}from"./QTable.9e6b612d.js";import{Q as N}from"./QChip.600a6998.js";import{Q as D}from"./QSpace.6a7bd18c.js";import{Q as O}from"./QSelect.97904e01.js";import{Q as B}from"./QForm.643e130b.js";import{Q as T}from"./QPage.562334ad.js";import{C as w}from"./ClosePopup.acab7d70.js";import"./moment.40bc58bf.js";import"./QBtnGroup.a996d5ee.js";import"./QMenu.8fa6cab6.js";import"./QMarkupTable.8a6b74ab.js";import"./format.2cae61da.js";const L={name:"UsuariosPage",data(){return{users:[],user:{},avatarFile:null,avatarPreview:null,dialogAvatar:!1,userDialog:!1,loading:!1,actionPeriodo:"",gestiones:[],filter:"",roles:["Vendedor","Administrador"],columns:[{name:"actions",label:"Acciones",align:"center"},{name:"name",label:"Nombre",align:"left",field:"name"},{name:"username",label:"Usuario",align:"left",field:"username"},{name:"role",label:"Rol",align:"left",field:"role"},{name:"permisos",label:"Permisos",align:"left",field:"permisos"},{name:"avatar",label:"Foto",align:"center"}],permisos:[],dialogPermisos:!1}},mounted(){this.usersGet(),this.permisosGet()},methods:{userChangeAvatar(t){this.user={...t},this.avatarFile=null,this.avatarPreview=null,this.dialogAvatar=!0},guardarAvatar(){if(!this.avatarFile){this.dialogAvatar=!1;return}this.loading=!0;const t=new FormData;t.append("avatar",this.avatarFile),this.$axios.post(`users/${this.user.id}?_method=PUT`,t).then(()=>{this.$alert.success("Foto actualizada"),this.usersGet(),this.dialogAvatar=!1}).finally(()=>{this.loading=!1})},onAvatarChange(t){const e=t.target.files[0];!e||(this.avatarFile=e,this.avatarPreview=URL.createObjectURL(e))},guardarPermisos(){this.loading=!0,this.$axios.put(`users/${this.user.id}/permisos`,{permissions:this.user.permissionsSelected}).then(()=>{this.$alert.success("Permisos actualizados"),this.dialogPermisos=!1,this.usersGet()}).catch(t=>{var e,m;this.$alert.error(((m=(e=t.response)==null?void 0:e.data)==null?void 0:m.message)||"Error al actualizar permisos")}).finally(()=>{this.loading=!1})},permisosGet(){this.loading=!0,this.$axios.get("permisos").then(t=>{this.permisos=t.data,this.loading=!1}).catch(t=>{this.$alert.error(t.response.data.message),this.loading=!1})},userNew(){this.user={name:"",username:"",email:"",password:"",role:"Vendedor"},this.avatarFile=null,this.avatarPreview=null,this.actionPeriodo="Nuevo",this.userDialog=!0},usersGet(){this.loading=!0,this.$axios.get("users").then(t=>{this.users=t.data}).catch(t=>{this.$alert.error(t.response.data.message)}).finally(()=>{this.loading=!1})},gestionGet(){this.loading=!0,this.$axios.get("gestiones").then(t=>{this.gestiones=t.data,this.loading=!1}).catch(t=>{this.$alert.error(t.response.data.message),this.loading=!1})},userPost(){this.loading=!0;const t=new FormData;Object.keys(this.user).forEach(e=>{t.append(e,this.user[e])}),this.avatarFile&&t.append("avatar",this.avatarFile),this.$axios.post("users",t,{headers:{"Content-Type":"multipart/form-data"}}).then(()=>{this.usersGet(),this.userDialog=!1,this.$alert.success("Usuario creado")}).finally(()=>{this.loading=!1})},userPut(){this.loading=!0;const t=new FormData;Object.keys(this.user).forEach(e=>{t.append(e,this.user[e])}),this.avatarFile&&t.append("avatar",this.avatarFile),this.$axios.post(`users/${this.user.id}?_method=PUT`,t).then(()=>{this.usersGet(),this.userDialog=!1,this.$alert.success("Usuario actualizado")}).finally(()=>{this.loading=!1})},dialogPermisosClick(t){var e;this.dialogPermisos=!0,this.user={...t,permissionsSelected:((e=t.permissions)==null?void 0:e.map(m=>m.name))||[]}},userEditPassword(t){this.user={...t},this.$alert.dialogPrompt("Nueva contrase\xF1a","Ingrese la nueva contrase\xF1a","password").onOk(e=>{this.$axios.put("updatePassword/"+t.id,{password:e}).then(m=>{this.usersGet(),this.$alert.success("Contrase\xF1a actualizada")}).catch(m=>{this.$alert.error(m.response.data.message)})})},userEdit(t){this.user={...t},this.actionPeriodo="Editar",this.userDialog=!0},userDelete(t){this.$alert.dialog("\xBFDesea eliminar el user?").onOk(()=>{this.loading=!0,this.$axios.delete("users/"+t).then(e=>{this.usersGet(),this.$alert.success("Periodo eliminado")}).catch(e=>{this.$alert.error(e.response.data.message)}).finally(()=>{this.loading=!1})})}}},R=["src"],j={style:{padding:"0",margin:"0",width:"150px"}},J={class:"q-mt-sm"},H={key:1,class:"q-mt-sm"},K=["src"],W={class:"text-right"},X={class:"text-bold"},Y={class:"flex flex-center q-mb-md"},Z=["src"],M={class:"flex flex-center"},$={class:"text-right q-mt-md"};function ee(t,e,m,le,r,o){return u(),p(T,{class:"q-pa-md"},{default:a(()=>[l(I,{rows:r.users,columns:r.columns,dense:"","wrap-cells":"",flat:"",bordered:"","rows-per-page-options":[0],title:"Usuarios",filter:r.filter},{"top-right":a(()=>[l(n,{color:"primary",label:"Actualizar",onClick:o.usersGet,"no-caps":"",icon:"refresh",loading:r.loading,class:"q-mr-sm"},null,8,["onClick","loading"]),l(n,{color:"green",label:"Nuevo",onClick:o.userNew,"no-caps":"",icon:"add_circle_outline",loading:r.loading},null,8,["onClick","loading"]),l(h,{modelValue:r.filter,"onUpdate:modelValue":e[0]||(e[0]=s=>r.filter=s),label:"Buscar",dense:"",outlined:""},{append:a(()=>[l(c,{name:"search"})]),_:1},8,["modelValue"])]),"body-cell-actions":a(s=>[l(V,{props:s},{default:a(()=>[l(z,{label:"Opciones","no-caps":"",size:"10px",dense:"",color:"primary"},{default:a(()=>[l(E,null,{default:a(()=>[v((u(),p(b,{clickable:"",onClick:g=>o.userEdit(s.row)},{default:a(()=>[l(d,{avatar:""},{default:a(()=>[l(c,{name:"edit"})]),_:1}),l(d,null,{default:a(()=>[l(k,null,{default:a(()=>e[20]||(e[20]=[C("Editar")])),_:1})]),_:1})]),_:2},1032,["onClick"])),[[w]]),v((u(),p(b,{clickable:"",onClick:g=>o.userDelete(s.row.id)},{default:a(()=>[l(d,{avatar:""},{default:a(()=>[l(c,{name:"delete"})]),_:1}),l(d,null,{default:a(()=>[l(k,null,{default:a(()=>e[21]||(e[21]=[C("Eliminar")])),_:1})]),_:1})]),_:2},1032,["onClick"])),[[w]]),v((u(),p(b,{clickable:"",onClick:g=>o.userEditPassword(s.row)},{default:a(()=>[l(d,{avatar:""},{default:a(()=>[l(c,{name:"edit"})]),_:1}),l(d,null,{default:a(()=>[l(k,null,{default:a(()=>e[22]||(e[22]=[C("Cambiar contrase\xF1a")])),_:1})]),_:1})]),_:2},1032,["onClick"])),[[w]]),v((u(),p(b,{clickable:"",onClick:g=>o.dialogPermisosClick(s.row)},{default:a(()=>[l(d,{avatar:""},{default:a(()=>[l(c,{name:"lock_open"})]),_:1}),l(d,null,{default:a(()=>[l(k,null,{default:a(()=>e[23]||(e[23]=[C("Permisos")])),_:1})]),_:1})]),_:2},1032,["onClick"])),[[w]]),v((u(),p(b,{clickable:"",onClick:g=>o.userChangeAvatar(s.row)},{default:a(()=>[l(d,{avatar:""},{default:a(()=>[l(c,{name:"photo_camera"})]),_:1}),l(d,null,{default:a(()=>[l(k,null,{default:a(()=>e[24]||(e[24]=[C("Cambiar foto")])),_:1})]),_:1})]),_:2},1032,["onClick"])),[[w]])]),_:2},1024)]),_:2},1024)]),_:2},1032,["props"])]),"body-cell-avatar":a(s=>[l(V,{props:s,align:"center"},{default:a(()=>[l(y,{size:"40px"},{default:a(()=>[i("img",{src:`${t.$url}../avatares/${s.row.avatar||"default.png"}`},null,8,R)]),_:2},1024)]),_:2},1032,["props"])]),"body-cell-role":a(s=>[l(V,{props:s},{default:a(()=>[l(N,{label:s.row.role,color:s.row.color,"text-color":"white",dense:"",size:"14px"},null,8,["label","color"])]),_:2},1032,["props"])]),"body-cell-permisos":a(s=>[l(V,{props:s},{default:a(()=>[i("ul",j,[(u(!0),Q(q,null,G(s.row.permissions,(g,A)=>(u(),Q("li",{key:A,style:{"list-style":"none",padding:"0",margin:"0"}},P(g.name),1))),128))])]),_:2},1032,["props"])]),_:1},8,["rows","columns","filter"]),l(x,{modelValue:r.userDialog,"onUpdate:modelValue":e[11]||(e[11]=s=>r.userDialog=s),persistent:""},{default:a(()=>[l(_,null,{default:a(()=>[l(f,{class:"q-pb-none row items-center"},{default:a(()=>[i("div",null,P(r.actionPeriodo)+" user ",1),l(D),l(n,{icon:"close",flat:"",round:"",dense:"",onClick:e[1]||(e[1]=s=>r.userDialog=!1)})]),_:1}),l(f,{class:"q-pt-none"},{default:a(()=>[l(B,{onSubmit:e[10]||(e[10]=s=>r.user.id?o.userPut():o.userPost())},{default:a(()=>[l(h,{modelValue:r.user.name,"onUpdate:modelValue":e[2]||(e[2]=s=>r.user.name=s),label:"Nombre",dense:"",outlined:"",rules:[s=>!!s||"Campo requerido"]},null,8,["modelValue","rules"]),l(h,{modelValue:r.user.username,"onUpdate:modelValue":e[3]||(e[3]=s=>r.user.username=s),label:"Usuario",dense:"",outlined:"",rules:[s=>!!s||"Campo requerido"]},null,8,["modelValue","rules"]),l(h,{modelValue:r.user.email,"onUpdate:modelValue":e[4]||(e[4]=s=>r.user.email=s),label:"Email",dense:"",outlined:"",hint:""},null,8,["modelValue"]),r.user.id?U("",!0):(u(),p(h,{key:0,modelValue:r.user.password,"onUpdate:modelValue":e[5]||(e[5]=s=>r.user.password=s),label:"Contrase\xF1a",dense:"",outlined:"",rules:[s=>!!s||"Campo requerido"]},null,8,["modelValue","rules"])),l(O,{modelValue:r.user.role,"onUpdate:modelValue":e[6]||(e[6]=s=>r.user.role=s),label:"Rol",dense:"",outlined:"",options:r.roles,rules:[s=>!!s||"Campo requerido"]},null,8,["modelValue","options","rules"]),i("div",J,[l(n,{label:"Seleccionar foto",icon:"photo",color:"primary",dense:"","no-caps":"",onClick:e[7]||(e[7]=s=>t.$refs.avatarInput.click())}),i("input",{type:"file",ref:"avatarInput",accept:"image/*",style:{display:"none"},onChange:e[8]||(e[8]=(...s)=>o.onAvatarChange&&o.onAvatarChange(...s))},null,544)]),r.avatarPreview?(u(),Q("div",H,[l(y,{size:"80px"},{default:a(()=>[i("img",{src:r.avatarPreview},null,8,K)]),_:1})])):U("",!0),i("div",W,[l(n,{color:"negative",label:"Cancelar",onClick:e[9]||(e[9]=s=>r.userDialog=!1),"no-caps":"",loading:r.loading},null,8,["loading"]),l(n,{color:"primary",label:"Guardar",type:"submit","no-caps":"",loading:r.loading,class:"q-ml-sm"},null,8,["loading"])])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(x,{modelValue:r.dialogAvatar,"onUpdate:modelValue":e[16]||(e[16]=s=>r.dialogAvatar=s)},{default:a(()=>[l(_,{style:{width:"400px"}},{default:a(()=>[l(f,{class:"row items-center q-pb-none"},{default:a(()=>[i("div",X,"Cambiar foto de "+P(r.user.name),1),l(D),l(n,{icon:"close",flat:"",round:"",dense:"",onClick:e[12]||(e[12]=s=>r.dialogAvatar=!1)})]),_:1}),l(f,null,{default:a(()=>[i("div",Y,[l(y,{size:"120px"},{default:a(()=>[i("img",{src:r.avatarPreview||`${t.$url}../avatares/${r.user.avatar||"default.png"}`},null,8,Z)]),_:1})]),i("div",M,[l(n,{label:"Seleccionar foto",icon:"photo",color:"primary","no-caps":"",dense:"",onClick:e[13]||(e[13]=s=>t.$refs.avatarDialogInput.click())}),i("input",{type:"file",ref:"avatarDialogInput",accept:"image/*",style:{display:"none"},onChange:e[14]||(e[14]=(...s)=>o.onAvatarChange&&o.onAvatarChange(...s))},null,544)])]),_:1}),l(f,{class:"text-right"},{default:a(()=>[l(n,{label:"Cancelar",flat:"",onClick:e[15]||(e[15]=s=>r.dialogAvatar=!1)}),l(n,{label:"Guardar",color:"primary",loading:r.loading,"no-caps":"",onClick:o.guardarAvatar},null,8,["loading","onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(x,{modelValue:r.dialogPermisos,"onUpdate:modelValue":e[19]||(e[19]=s=>r.dialogPermisos=s)},{default:a(()=>[l(_,null,{default:a(()=>[l(f,{class:"q-pb-none row items-center"},{default:a(()=>[i("div",null," Permisos de "+P(r.user.name),1),l(D),l(n,{icon:"close",flat:"",round:"",dense:"",onClick:e[17]||(e[17]=s=>r.dialogPermisos=!1)})]),_:1}),l(f,{class:"q-pt-none"},{default:a(()=>[l(S,{modelValue:r.user.permissionsSelected,"onUpdate:modelValue":e[18]||(e[18]=s=>r.user.permissionsSelected=s),options:r.permisos.map(s=>({label:s.name,value:s.name})),type:"checkbox",color:"green",dense:""},null,8,["modelValue","options"]),i("div",$,[l(n,{label:"Guardar permisos",color:"primary",onClick:o.guardarPermisos,loading:r.loading,"no-caps":""},null,8,["onClick","loading"])])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}var be=F(L,[["render",ee]]);export{be as default};
